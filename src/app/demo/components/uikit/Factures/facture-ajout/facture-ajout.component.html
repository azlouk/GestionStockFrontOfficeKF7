<ng-template #content let-modal>
    <div class="modal-header">
        <p-button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"/>
    </div>
    <h1 class="text-center mb-4 mt-3 PrimaryColorTitle fw-bold">Ajouter un nouvel utilisateur</h1>
    <div class="container-fluid  bg-white shadow-lg p-2 " >
        <form [formGroup]="userForm" class="p-flex justify-content-start">
            <div class="form-row bg-white border-0">
                <input formControlName="nom" type="text" placeholder="Nom">
                <input formControlName="prenom" type="text" placeholder="Prénom">
            </div>
            <div class="form-row bg-white border-0">
                <input formControlName="email" type="text" placeholder="Email">
                <input formControlName="tel" type="text" placeholder="Numéro de téléphone">
            </div>
            <div class="form-row bg-white border-0">
                <input formControlName="address" type="text" placeholder="Adresse">

                <select formControlName="role" [(ngModel)]="RolesData">
                    <option *ngFor="let role of roles" [value]="role">{{ role }}</option>
                </select>
            </div>
        </form>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn  btn-light text-success" (click)="onSubmit()">Enregistrer</button>
    </div>
</ng-template>

<div class="container-fluid px-5 py-5 p-flex justify-content-center">

    <div class="subscribe1">
        <div class="flex justify-content-end">
            <p-button icon="pi pi-times" (click)="returnBack()" styleClass="p-button-rounded p-button-danger p-button-text p-button-raised"></p-button>

        </div>
        <div class="container-lg mt-2 ">
            <h1 class="text-center mb-2 PrimaryColorTitle">Ajouter une nouvelle Facture</h1>
            <div class="switch-holder col-lg shadow-lg p-flex justify-content-center">
                <div class="col p-flex align-items-center gap-3">
                    <label>Dépôt</label>

                    <p-dropdown
                        [(ngModel)]="newFacture.depot"
                        [options]="depots"
                        optionLabel="nom"
                        placeholder="Select a Depot"
                        class="w-50">
                    </p-dropdown>
                </div>
                <div class="col  p-flex justify-content-center">
                    <div class="switch-label fs-3  ">
                        <i class="bi bi-journals"></i><span>Type facture</span>
                    </div>
                    <div class="switch-toggle">
                        <input type="checkbox" [ngModel]="this.newFacture.typeFacture !=='FACTURE_ACHAT'"  (change)="changeType()" id="bluetooth">
                        <label for="bluetooth"></label>
                    </div>
                    <button type="button" class="btn  bi-info-circle-fill" data-bs-toggle="tooltip" data-bs-placement="top" title="Basculer pour changer type facture (Achat ou Vente)">

                    </button>
                </div>


            </div>

            <div class="form-row m-4 mt-5  shadow-lg rounded-4 p-3">


                <!-- Champ de saisie pour la date -->
                <div class="col-md   p-flex justify-content-center">

                    <div class="col-xl-4 mt-3 p-2">
                        <label>Date  facture</label>
                        <p-calendar [(ngModel)]="newFacture.date" [showIcon]="true"></p-calendar>


                    </div>


                </div>


                <div class="col-5 mt-3 p-2" *ngIf="newFacture.typeFacture=='FACTURE_ACHAT'">
                    <label>Réference achat (Option)</label>
                    <input type="text" [(ngModel)]="newFacture.reference" name="reference" placeholder="Exemple : FACT-00001" required>
                </div>
            </div>
        </div>



        <div class="  p-2  shadow-lg p-flex gap-10">




            <!-- Champ de sélection pour l'utilisateur -->
            <div class="col-xl-4 mt-3 ">
                <label class="PrimaryColorTitle fs-4 fa-bold pi pi-user p-2 ">Transporteur </label>
                <p-listbox [options]="utilisateursTransporteur" [(ngModel)]="newFacture.transporteur" optionLabel="firstname" [filter]="true" [style]="{ width: '12rem' , height:'8rem' }" ></p-listbox>


            </div>

            <div  class="col-lg shadow-sm m-auto  " style="height: 80px">
                <div class="flex justify-content-end" >
                    <p-button type="button" class="btn btn-outline-success mr-5" routerLink="/add-user">

                        Ajouter Utilisateur
                    </p-button>
                </div>
                <table *ngIf="newFacture.transporteur.id!=0"  class="table table-striped table-hover w-full ">
                    <thead>
                    <tr  class="fs-5" style="  --bs-table-color: #0056b3">
                        <th scope="col" >Nom</th>
                        <th scope="col" >Prénom</th>
                        <th scope="col"  >Email</th>
                        <th scope="col"  >Téléphone</th>

                    </tr>
                    </thead>
                    <tbody   class="table-group-divider">
                    <tr>
                        <td>{{ newFacture.transporteur.firstname }}</td>
                        <td>{{ newFacture.transporteur.lastname }}</td>
                        <td>{{ newFacture.transporteur.email }}</td>
                        <td>{{ newFacture.transporteur.telephone }}</td>
                    </tr>
                    </tbody>
                </table>



            </div>



        </div>
        <div class="  p-2  shadow-lg p-flex  justify-content-center  " *ngIf="newFacture.typeFacture!=='FACTURE_ACHAT'">

            <div class="col-xl-4 mt-3 ">
                <label class="PrimaryColorTitle fs-4 fa-bold pi pi-user p-2">Client </label>
                <p-listbox [options]="utilisateurs" [(ngModel)]="newFacture.client" optionLabel="firstname" [filter]="true" [style]="{ width: '12rem' , height:'8rem' }" ></p-listbox>



            </div>
            <div  class="col-lg shadow-sm m-auto " style="height: 80px">
                <table *ngIf="newFacture.client.id!=0"  class="table table-striped table-hover">
                    <thead>
                    <tr  class="fs-5" style="  --bs-table-color: #0056b3">
                        <th scope="col" >Nom</th>
                        <th scope="col" >Prénom</th>
                        <th scope="col"  >Email</th>
                        <th scope="col"  >Téléphone</th>

                    </tr>
                    </thead>
                    <tbody   class="table-group-divider">
                    <tr>
                        <td>{{ newFacture.client.firstname }}</td>
                        <td>{{ newFacture.client.lastname }}</td>
                        <td>{{ newFacture.client.email }}</td>
                        <td>{{ newFacture.client.telephone }}</td>
                    </tr>
                    </tbody>
                </table><br>

            </div>
        </div>
        <div class="p-2  shadow-lg p-flex justify-content-center">




            <div class="col-xl-4 mt-3" *ngIf="newFacture.typeFacture=='FACTURE_ACHAT'">
                <label class="PrimaryColorTitle fs-4 fa-bold pi pi-user p-2">Fournisseur </label>

                <p-listbox [options]="providers" [(ngModel)]="newFacture.provider" optionLabel="firstname" [filter]="true" [style]="{ width: '12rem' , height:'8rem' }" ></p-listbox>

            </div>
            <div  class="col-lg shadow-sm m-auto " style="height: 80px;  ">
                <table *ngIf="newFacture.provider.id!=0"  class="table table-striped table-hover">
                    <thead>
                    <tr  class="fs-5" style="  --bs-table-color: #0056b3">
                        <th scope="col" >Nom</th>
                        <th scope="col" >Prénom</th>
                        <th scope="col"  >Email</th>
                        <th scope="col"  >Téléphone</th>

                    </tr>
                    </thead>
                    <tbody   class="table-group-divider">
                    <tr>
                        <td>{{ newFacture.provider.firstname }}</td>
                        <td>{{ newFacture.provider.lastname }}</td>
                        <td>{{ newFacture.provider.email }}</td>
                        <td>{{ newFacture.provider.telephone }}</td>
                    </tr>
                    </tbody>
                </table><br>

            </div>

        </div>
<!--        <div class="  row m-2">-->
<!--            <app-canvas [message]="parentMessage" (onMessage)="receiveMessage($event)"  ></app-canvas>-->
<!--        </div>-->
        <div class="p-grid p-m-2">
            <app-canvas [message]="parentMessage" (onMessage)="receiveMessage($event)"></app-canvas>
        </div>
<!--        <p-messages [(value)]="messages" [enableService]="false" [closable]="false"></p-messages>-->

        <div class="form-row m-4 mt-5 " >

            <p-table [value]="produitsFactures" [scrollable]="true" scrollHeight="400px">
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="id" style="width:20%">Nom Produits <p-sortIcon field="id"></p-sortIcon></th>
                        <th pSortableColumn="nom" style="width:20%">Quantité <p-sortIcon field="nom"></p-sortIcon></th>
                        <th   style="width:20%">Prix (TND) </th>
                        <th pSortableColumn="price" style="width:20%">Total (TND) <p-sortIcon field="price"></p-sortIcon></th>
                        <th style="width:20%">   </th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-l>
                    <tr >

                        <td>
                            {{l.produit.nom}}
                        </td>
                        <td>
                            <input class="text-center" id="{{l.produit.id}}" type="number"  [(ngModel)]="l.quantite" [max]="l.produit.qantite"   (change)="calculeFactureTotal()" name="quantiteProduit">
                        </td>

                        <td class="fw-bold fs-4  text-red-600">
                            {{getPrixCalculate(l)|number}}
                        </td>
                        <td class="fw-bold fs-3 text-black">
                            {{getPrixCalculate(l)*l.quantite|number}}
                        </td>
                        <td>
                            <button type="button" class="btn   bi-trash text-danger " (click)="deleteProduct(l)"></button>
                        </td>
                    </tr>
                </ng-template>
            </p-table>




        </div>

        <div class="form-row flex-column float-end  p-5     shadow-lg bg-body-tertiary " style="margin: 60px" >

            <div class="col flex-auto p-2">
                <label class="block font-bold mb-2 PrimaryColorTitle" >Réglement : </label>
                <p-inputNumber [(ngModel)]="newFacture.montant" inputId="currency-us" mode="currency" currency="TND" locale="en-US"> </p-inputNumber>
            </div>
            <div class="flex-auto p-2">
                <label class="font-bold block mb-2 PrimaryColorTitle" >Tax : </label>
                <p-inputNumber [(ngModel)]="newFacture.montantTaxe" [disabled]="false" inputId="percent" prefix="%"> </p-inputNumber>
            </div>
            <div class="flex-auto p-2">
                <label class="block font-bold mb-2PrimaryColorTitle " >Total : </label>
                <label class="text-danger fs-3 fw-bold text-center shadow-lg rounded-3 p-2">{{newFacture.montant|number}}</label>
            </div>
        </div>
        <!-- Bouton de soumission du formulaire -->
        <p-button class="submit-btn  mb-4 mr-5 "   (click)="createNewFacture()">Ajouter</p-button>
    </div>
</div>
